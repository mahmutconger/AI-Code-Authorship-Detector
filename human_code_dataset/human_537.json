{
    "code": "def _add_overlay_to_image(\n\timage: Image.Image,\n\tstep_number: int,\n\tgoal_text: str,\n\tregular_font: ImageFont.FreeTypeFont,\n\ttitle_font: ImageFont.FreeTypeFont,\n\tmargin: int,\n\tlogo: Image.Image | None = None,\n\tdisplay_step: bool = True,\n\ttext_color: tuple[int, int, int, int] = (255, 255, 255, 255),\n\ttext_box_color: tuple[int, int, int, int] = (0, 0, 0, 255),\n) -> Image.Image:\n\t\"\"\"Add step number and goal overlay to an image.\"\"\"\n\n\tfrom PIL import Image, ImageDraw\n\n\tgoal_text = decode_unicode_escapes_to_utf8(goal_text)\n\timage = image.convert('RGBA')\n\ttxt_layer = Image.new('RGBA', image.size, (0, 0, 0, 0))\n\tdraw = ImageDraw.Draw(txt_layer)\n\tif display_step:\n\t\t# Add step number (bottom left)\n\t\tstep_text = str(step_number)\n\t\tstep_bbox = draw.textbbox((0, 0), step_text, font=title_font)\n\t\tstep_width = step_bbox[2] - step_bbox[0]\n\t\tstep_height = step_bbox[3] - step_bbox[1]\n\n\t\t# Position step number in bottom left\n\t\tx_step = margin + 10  # Slight additional offset from edge\n\t\ty_step = image.height - margin - step_height - 10  # Slight offset from bottom\n\n\t\t# Draw rounded rectangle background for step number\n\t\tpadding = 20  # Increased padding\n\t\tstep_bg_bbox = (\n\t\t\tx_step - padding,\n\t\t\ty_step - padding,\n\t\t\tx_step + step_width + padding,\n\t\t\ty_step + step_height + padding,\n\t\t)\n\t\tdraw.rounded_rectangle(\n\t\t\tstep_bg_bbox,\n\t\t\tradius=15,  # Add rounded corners\n\t\t\tfill=text_box_color,\n\t\t)\n\n\t\t# Draw step number\n\t\tdraw.text(\n\t\t\t(x_step, y_step),\n\t\t\tstep_text,\n\t\t\tfont=title_font,\n\t\t\tfill=text_color,\n\t\t)\n\n\t# Draw goal text (centered, bottom)\n\tmax_width = image.width - (4 * margin)\n\twrapped_goal = _wrap_text(goal_text, title_font, max_width)\n\tgoal_bbox = draw.multiline_textbbox((0, 0), wrapped_goal, font=title_font)\n\tgoal_width = goal_bbox[2] - goal_bbox[0]\n\tgoal_height = goal_bbox[3] - goal_bbox[1]\n\n\t# Center goal text horizontally, place above step number\n\tx_goal = (image.width - goal_width) // 2\n\ty_goal = y_step - goal_height - padding * 4  # More space between step and goal\n\n\t# Draw rounded rectangle background for goal\n\tpadding_goal = 25  # Increased padding for goal\n\tgoal_bg_bbox = (\n\t\tx_goal - padding_goal,  # Remove extra space for logo\n\t\ty_goal - padding_goal,\n\t\tx_goal + goal_width + padding_goal,\n\t\ty_goal + goal_height + padding_goal,\n\t)\n\tdraw.rounded_rectangle(\n\t\tgoal_bg_bbox,\n\t\tradius=15,  # Add rounded corners\n\t\tfill=text_box_color,\n\t)\n\n\t# Draw goal text\n\tdraw.multiline_text(\n\t\t(x_goal, y_goal),\n\t\twrapped_goal,\n\t\tfont=title_font,\n\t\tfill=text_color,\n\t\talign='center',\n\t)\n\n\t# Add logo if provided (top right corner)\n\tif logo:\n\t\tlogo_layer = Image.new('RGBA', image.size, (0, 0, 0, 0))\n\t\tlogo_margin = 20\n\t\tlogo_x = image.width - logo.width - logo_margin\n\t\tlogo_layer.paste(logo, (logo_x, logo_margin), logo if logo.mode == 'RGBA' else None)\n\t\ttxt_layer = Image.alpha_composite(logo_layer, txt_layer)\n\n\t# Composite and convert\n\tresult = Image.alpha_composite(image, txt_layer)\n\treturn result.convert('RGB')",
    "source": "github_repo:browser-use/browser-use",
    "file": "browser_use/agent/gif.py",
    "license": "MIT",
    "language": "python"
}