{
    "code": "def copy_mtp(d1, d2, tag, rm):\n    nt = next(d1.execute(\"select count(w) from mt where k = ?\", (tag,)))[0]\n    n = 0\n    ncopy = 0\n    nskip = 0\n    for w1s, k, v in d1.execute(\"select * from mt where k = ?\", (tag,)):\n        n += 1\n        if n % 25_000 == 0:\n            m = f\"\\033[36m{n:,} of {nt:,} tags checked, so far {ncopy} copied, {nskip} skipped\\033[0m\"\n            print(m)\n\n        q = \"select w, rd, fn from up where substr(w,1,16) = ?\"\n        w1, rd, fn = d1.execute(q, (w1s,)).fetchone()\n        if rd.split(\"/\", 1)[0] == \".hist\":\n            continue\n\n        if BY_PATH:\n            q = \"select w from up where rd = ? and fn = ?\"\n            w2 = d2.execute(q, (rd, fn)).fetchone()\n        else:\n            q = \"select w from up where substr(w,1,16) = ? and +w = ?\"\n            w2 = d2.execute(q, (w1s, w1)).fetchone()\n\n        if not w2:\n            continue\n\n        w2s = w2[0][:16]\n        hit = d2.execute(\"select v from mt where w = ? and +k = ?\", (w2s, k)).fetchone()\n        if hit:\n            hit = hit[0]\n\n        if hit != v:\n            if NC and hit is not None:\n                nskip += 1\n                continue\n\n            ncopy += 1\n            if hit is not None:\n                d2.execute(\"delete from mt where w = ? and +k = ?\", (w2s, k))\n\n            d2.execute(\"insert into mt values (?,?,?)\", (w2s, k, v))\n            if rm:\n                d2.execute(\"delete from mt where w = ? and +k = 't:mtp'\", (w2s,))\n\n    d2.commit()\n    print(f\"copied {ncopy} {tag} tags over, skipped {nskip}\")",
    "source": "github_repo:9001/copyparty",
    "file": "bin/dbtool.py",
    "license": "MIT",
    "language": "python"
}