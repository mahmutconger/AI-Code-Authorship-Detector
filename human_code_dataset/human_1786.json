{
    "code": "class BaiduWenxinBot(Bot):\n\n    def __init__(self):\n        super().__init__()\n        wenxin_model = conf().get(\"baidu_wenxin_model\")\n        self.prompt_enabled = conf().get(\"baidu_wenxin_prompt_enabled\")\n        if self.prompt_enabled:\n            self.prompt = conf().get(\"character_desc\", \"\")\n            if self.prompt == \"\":\n                logger.warn(\"[BAIDU] Although you enabled model prompt, character_desc is not specified.\")\n        if wenxin_model is not None:\n            wenxin_model = conf().get(\"baidu_wenxin_model\") or \"eb-instant\"\n        else:\n            if conf().get(\"model\") and conf().get(\"model\") == const.WEN_XIN:\n                wenxin_model = \"completions\"\n            elif conf().get(\"model\") and conf().get(\"model\") == const.WEN_XIN_4:\n                wenxin_model = \"completions_pro\"\n\n        self.sessions = SessionManager(BaiduWenxinSession, model=wenxin_model)\n\n    def reply(self, query, context=None):\n        # acquire reply content\n        if context and context.type:\n            if context.type == ContextType.TEXT:\n                logger.info(\"[BAIDU] query={}\".format(query))\n                session_id = context[\"session_id\"]\n                reply = None\n                if query == \"#清除记忆\":\n                    self.sessions.clear_session(session_id)\n                    reply = Reply(ReplyType.INFO, \"记忆已清除\")\n                elif query == \"#清除所有\":\n                    self.sessions.clear_all_session()\n                    reply = Reply(ReplyType.INFO, \"所有人记忆已清除\")\n                else:\n                    session = self.sessions.session_query(query, session_id)\n                    result = self.reply_text(session)\n                    total_tokens, completion_tokens, reply_content = (\n                        result[\"total_tokens\"],\n                        result[\"completion_tokens\"],\n                        result[\"content\"],\n                    )\n                    logger.debug(\n                        \"[BAIDU] new_query={}, session_id={}, reply_cont={}, completion_tokens={}\".format(session.messages, session_id, reply_content, completion_tokens)\n                    )\n\n                    if total_tokens == 0:\n                        reply = Reply(ReplyType.ERROR, reply_content)\n                    else:\n                        self.sessions.session_reply(reply_content, session_id, total_tokens)\n                        reply = Reply(ReplyType.TEXT, reply_content)\n                return reply\n            elif context.type == ContextType.IMAGE_CREATE:\n                ok, retstring = self.create_img(query, 0)\n                reply = None\n                if ok:\n                    reply = Reply(ReplyType.IMAGE_URL, retstring)\n                else:\n                    reply = Reply(ReplyType.ERROR, retstring)\n                return reply\n\n    def reply_text(self, session: BaiduWenxinSession, retry_count=0):\n        try:\n            logger.info(\"[BAIDU] model={}\".format(session.model))\n            access_token = self.get_access_token()\n            if access_token == 'None':\n                logger.warn(\"[BAIDU] access token 获取失败\")\n                return {\n                    \"total_tokens\": 0,\n                    \"completion_tokens\": 0,\n                    \"content\": 0,\n                    }\n            url = \"https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/\" + session.model + \"?access_token=\" + access_token\n            headers = {\n                'Content-Type': 'application/json'\n            }\n            payload = {'messages': session.messages, 'system': self.prompt} if self.prompt_enabled else {'messages': session.messages}\n            response = requests.request(\"POST\", url, headers=headers, data=json.dumps(payload))\n            response_text = json.loads(response.text)\n            logger.info(f\"[BAIDU] response text={response_text}\")\n            res_content = response_text[\"result\"]\n            total_tokens = response_text[\"usage\"][\"total_tokens\"]\n            completion_tokens = response_text[\"usage\"][\"completion_tokens\"]\n            logger.info(\"[BAIDU] reply={}\".format(res_content))\n            return {\n                \"total_tokens\": total_tokens,\n                \"completion_tokens\": completion_tokens,\n                \"content\": res_content,\n            }\n        except Exception as e:\n            need_retry = retry_count < 2\n            logger.warn(\"[BAIDU] Exception: {}\".format(e))\n            need_retry = False\n            self.sessions.clear_session(session.session_id)\n            result = {\"total_tokens\": 0, \"completion_tokens\": 0, \"content\": \"出错了: {}\".format(e)}\n            return result\n\n    def get_access_token(self):\n        \"\"\"\n        使用 AK，SK 生成鉴权签名（Access Token）\n        :return: access_token，或是None(如果错误)\n        \"\"\"\n        url = \"https://aip.baidubce.com/oauth/2.0/token\"\n        params = {\"grant_type\": \"client_credentials\", \"client_id\": BAIDU_API_KEY, \"client_secret\": BAIDU_SECRET_KEY}\n        return str(requests.post(url, params=params).json().get(\"access_token\"))",
    "source": "github_repo:zhayujie/chatgpt-on-wechat",
    "file": "bot/baidu/baidu_wenxin.py",
    "license": "MIT",
    "language": "python"
}