{
    "code": "def compare(n1, d1, n2, d2, verbose):\n    nt = next(d1.execute(\"select count(w) from up\"))[0]\n    n = 0\n    miss = 0\n    for w1, rd, fn in d1.execute(\"select w, rd, fn from up\"):\n        n += 1\n        if n % 25_000 == 0:\n            m = f\"\\033[36mchecked {n:,} of {nt:,} files in {n1} against {n2}\\033[0m\"\n            print(m)\n\n        if rd.split(\"/\", 1)[0] == \".hist\":\n            continue\n\n        if BY_PATH:\n            q = \"select w from up where rd = ? and fn = ?\"\n            hit = d2.execute(q, (rd, fn)).fetchone()\n        else:\n            q = \"select w from up where substr(w,1,16) = ? and +w = ?\"\n            hit = d2.execute(q, (w1[:16], w1)).fetchone()\n\n        if not hit:\n            miss += 1\n            if verbose:\n                print(f\"file in {n1} missing in {n2}: [{w1}] {rd}/{fn}\")\n\n    print(f\" {miss} files in {n1} missing in {n2}\\n\")\n\n    nt = next(d1.execute(\"select count(w) from mt\"))[0]\n    n = 0\n    miss = {}\n    nmiss = 0\n    for w1s, k, v in d1.execute(\"select * from mt\"):\n\n        n += 1\n        if n % 100_000 == 0:\n            m = f\"\\033[36mchecked {n:,} of {nt:,} tags in {n1} against {n2}, so far {nmiss} missing tags\\033[0m\"\n            print(m)\n\n        q = \"select w, rd, fn from up where substr(w,1,16) = ?\"\n        w1, rd, fn = d1.execute(q, (w1s,)).fetchone()\n        if rd.split(\"/\", 1)[0] == \".hist\":\n            continue\n\n        if BY_PATH:\n            q = \"select w from up where rd = ? and fn = ?\"\n            w2 = d2.execute(q, (rd, fn)).fetchone()\n        else:\n            q = \"select w from up where substr(w,1,16) = ? and +w = ?\"\n            w2 = d2.execute(q, (w1s, w1)).fetchone()\n\n        if w2:\n            w2 = w2[0]\n\n        v2 = None\n        if w2:\n            v2 = d2.execute(\n                \"select v from mt where w = ? and +k = ?\", (w2[:16], k)\n            ).fetchone()\n            if v2:\n                v2 = v2[0]\n\n        # if v != v2 and v2 and k in [\".bpm\", \"key\"] and n2 == \"src\":\n        #    print(f\"{w} [{rd}/{fn}] {k} = [{v}] / [{v2}]\")\n\n        if v2 is not None:\n            if k.startswith(\".\"):\n                try:\n                    diff = abs(float(v) - float(v2))\n                    if diff > float(v) / 0.9:\n                        v2 = None\n                    else:\n                        v2 = v\n                except:\n                    pass\n\n            if v != v2:\n                v2 = None\n\n        if v2 is None:\n            nmiss += 1\n            try:\n                miss[k] += 1\n            except:\n                miss[k] = 1\n\n            if verbose:\n                print(f\"missing in {n2}: [{w1}] [{rd}/{fn}] {k} = {v}\")\n\n    for k, v in sorted(miss.items()):\n        if v:\n            print(f\"{n1} has {v:7} more {k:<7} tags than {n2}\")\n\n    print(f\"in total, {nmiss} missing tags in {n2}\\n\")",
    "source": "github_repo:9001/copyparty",
    "file": "bin/dbtool.py",
    "license": "MIT",
    "language": "python"
}