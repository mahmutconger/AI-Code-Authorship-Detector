{
    "code": "def create_img(self, query, retry_count=0, api_key=None):\n        text_to_image_model = conf().get(\"text_to_image\")\n        if text_to_image_model == \"dall-e-2\":\n            api_version = \"2023-06-01-preview\"\n            endpoint = conf().get(\"azure_openai_dalle_api_base\",\"open_ai_api_base\")\n            # 检查endpoint是否以/结尾\n            if not endpoint.endswith(\"/\"):\n                endpoint = endpoint + \"/\"\n            url = \"{}openai/images/generations:submit?api-version={}\".format(endpoint, api_version)\n            api_key = conf().get(\"azure_openai_dalle_api_key\",\"open_ai_api_key\")\n            headers = {\"api-key\": api_key, \"Content-Type\": \"application/json\"}\n            try:\n                body = {\"prompt\": query, \"size\": conf().get(\"image_create_size\", \"256x256\"),\"n\": 1}\n                submission = requests.post(url, headers=headers, json=body)\n                operation_location = submission.headers['operation-location']\n                status = \"\"\n                while (status != \"succeeded\"):\n                    if retry_count > 3:\n                        return False, \"图片生成失败\"\n                    response = requests.get(operation_location, headers=headers)\n                    status = response.json()['status']\n                    retry_count += 1\n                image_url = response.json()['result']['data'][0]['url']\n                return True, image_url\n            except Exception as e:\n                logger.error(\"create image error: {}\".format(e))\n                return False, \"图片生成失败\"\n        elif text_to_image_model == \"dall-e-3\":\n            api_version = conf().get(\"azure_api_version\", \"2024-02-15-preview\")\n            endpoint = conf().get(\"azure_openai_dalle_api_base\",\"open_ai_api_base\")\n            # 检查endpoint是否以/结尾\n            if not endpoint.endswith(\"/\"):\n                endpoint = endpoint + \"/\"\n            url = \"{}openai/deployments/{}/images/generations?api-version={}\".format(endpoint, conf().get(\"azure_openai_dalle_deployment_id\",\"text_to_image\"),api_version)\n            api_key = conf().get(\"azure_openai_dalle_api_key\",\"open_ai_api_key\")\n            headers = {\"api-key\": api_key, \"Content-Type\": \"application/json\"}\n            try:\n                body = {\"prompt\": query, \"size\": conf().get(\"image_create_size\", \"1024x1024\"), \"quality\": conf().get(\"dalle3_image_quality\", \"standard\")}\n                response = requests.post(url, headers=headers, json=body)\n                response.raise_for_status()  # 检查请求是否成功\n                data = response.json()\n\n                # 检查响应中是否包含图像 URL\n                if 'data' in data and len(data['data']) > 0 and 'url' in data['data'][0]:\n                    image_url = data['data'][0]['url']\n                    return True, image_url\n                else:\n                    error_message = \"响应中没有图像 URL\"\n                    logger.error(error_message)\n                    return False, \"图片生成失败\"\n\n            except requests.exceptions.RequestException as e:\n                # 捕获所有请求相关的异常\n                try:\n                    error_detail = response.json().get('error', {}).get('message', str(e))\n                except ValueError:\n                    error_detail = str(e)\n                error_message = f\"{error_detail}\"\n                logger.error(error_message)\n                return False, error_message\n\n            except Exception as e:\n                # 捕获所有其他异常\n                error_message = f\"生成图像时发生错误: {e}\"\n                logger.error(error_message)\n                return False, \"图片生成失败\"\n        else:\n            return False, \"图片生成失败，未配置text_to_image参数\"",
    "source": "github_repo:zhayujie/chatgpt-on-wechat",
    "file": "bot/chatgpt/chat_gpt_bot.py",
    "license": "MIT",
    "language": "python"
}