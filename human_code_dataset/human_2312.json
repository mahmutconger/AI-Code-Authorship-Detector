{
    "code": "def prepare_data(self, filters: dict | None = None, max_workers: int | None = None) -> None:\n        \"\"\"\n        Generate required data\n        \"\"\"\n        # List for feature data results\n        results: list = []\n\n        # Iterate through expressions for calculation\n        expressions: list[tuple[str, str | pl.expr.expr.Expr]] = list(self.feature_expressions.items())\n\n        if self.label_expression:\n            expressions.append((\"label\", self.label_expression))\n\n        # Create process pool\n        logger.info(\"开始计算表达式因子特征\")\n\n        args: list[tuple] = [(self.df, name, expression) for name, expression in expressions]\n\n        context: BaseContext = get_context(\"spawn\")\n\n        with context.Pool(processes=max_workers) as pool:\n            # Calculate all expressions in parallel\n            it = pool.imap(calculate_feature, args)\n\n            # Collect results\n            for result in tqdm(it, total=len(args)):\n                results.append(result)\n\n        self.result_df = self.df.with_columns(results)\n\n        # Merge result data factor features\n        logger.info(\"开始合并结果数据因子特征\")\n\n        label_exist: bool = \"label\" in self.result_df\n        for name, feature_result in tqdm(self.feature_results.items()):\n            feature_result = feature_result.rename({\"data\": name})\n            self.result_df = self.result_df.join(feature_result, on=[\"datetime\", \"vt_symbol\"], how=\"left\")\n\n        if label_exist:\n            # Put label at the last column\n            cols: list = [col for col in self.result_df.columns if col != \"label\"] + [\"label\"]\n            self.result_df = self.result_df.select(cols).sort([\"datetime\", \"vt_symbol\"])\n\n        # Generate raw data\n        raw_df = self.result_df.fill_null(float(\"nan\"))\n\n        if filters:\n            logger.info(\"开始筛选成分股数据\")\n\n            filtered_df = pl.DataFrame()\n\n            for vt_symbol, ranges in tqdm(filters.items(), total=len(filters)):\n                for start, end in ranges:\n                    temp_df = raw_df.filter(\n                        (pl.col(\"vt_symbol\") == vt_symbol) & (pl.col(\"datetime\") >= pl.lit(start)) & (pl.col(\"datetime\") <= pl.lit(end))\n                    )\n                    filtered_df = pl.concat([filtered_df, temp_df])\n\n            raw_df = filtered_df\n\n        # Only keep feature columns\n        select_columns: list[str] = [\"datetime\", \"vt_symbol\"] + raw_df.columns[self.df.width:]\n        self.raw_df = raw_df.select(select_columns).sort([\"datetime\", \"vt_symbol\"])\n\n        self.infer_df = self.raw_df\n        self.learn_df = self.raw_df",
    "source": "github_repo:vnpy/vnpy",
    "file": "vnpy/alpha/dataset/template.py",
    "license": "MIT",
    "language": "python"
}