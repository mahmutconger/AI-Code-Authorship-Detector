{
    "code": "def answer(topic=None):\n    \"\"\"\n    Main rendering function, it processes incoming weather queries.\n    Depending on user agent it returns output in HTML or ANSI format.\n\n    Incoming data:\n        request.args\n        request.headers\n        request.remote_addr\n        request.referrer\n        request.query_string\n    \"\"\"\n\n    user_agent = request.headers.get(\"User-Agent\", \"\").lower()\n    html_needed = _is_html_needed(user_agent)\n    options = parse_args(request.args)\n\n    if topic in [\n        \"apple-touch-icon-precomposed.png\",\n        \"apple-touch-icon.png\",\n        \"apple-touch-icon-120x120-precomposed.png\",\n    ] or (topic is not None and any(topic.endswith(\"/\" + x) for x in [\"favicon.ico\"])):\n        return \"\"\n\n    request_id = request.cookies.get(\"id\")\n    if topic is not None and topic.lstrip(\"/\") == \":last\":\n        if request_id:\n            topic = last_query(request_id)\n        else:\n            return \"ERROR: you have to set id for your requests to use /:last\\n\"\n    else:\n        if request_id:\n            save_query(request_id, topic)\n\n    if request.method == \"POST\":\n        process_post_request(request, html_needed)\n        if html_needed:\n            return redirect(\"/\")\n        return \"OK\\n\"\n\n    if \"topic\" in request.args:\n        return redirect(\"/%s\" % request.args.get(\"topic\"))\n\n    if topic is None:\n        topic = \":firstpage\"\n\n    if topic.startswith(\":shell-x/\"):\n        return _proxy()\n        # return requests.get('http://127.0.0.1:3000'+topic[8:]).text\n\n    lang = get_answer_language(request)\n    if lang:\n        options[\"lang\"] = lang\n\n    ip_address = get_request_ip(request)\n    if \"+\" in topic:\n        not_allowed = LIMITS.check_ip(ip_address)\n        if not_allowed:\n            return \"429 %s\\n\" % not_allowed, 429\n\n    html_is_needed = _is_html_needed(user_agent) and not is_result_a_script(topic)\n    if html_is_needed:\n        output_format = \"html\"\n    else:\n        output_format = \"ansi\"\n    result, found = cheat_wrapper(\n        topic, request_options=options, output_format=output_format\n    )\n    if \"Please come back in several hours\" in result and html_is_needed:\n        malformed_response = open(\n            os.path.join(CONFIG[\"path.internal.malformed\"])\n        ).read()\n        return malformed_response\n\n    log_query(ip_address, found, topic, user_agent)\n    if html_is_needed:\n        return result\n    return Response(result, mimetype=\"text/plain\")",
    "source": "github_repo:chubin/cheat.sh",
    "file": "bin/app.py",
    "license": "MIT",
    "language": "python"
}