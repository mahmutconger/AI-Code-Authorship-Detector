{
    "code": "def _get_stream_info_guesses(\n        self, file_stream: BinaryIO, base_guess: StreamInfo\n    ) -> List[StreamInfo]:\n        \"\"\"\n        Given a base guess, attempt to guess or expand on the stream info using the stream content (via magika).\n        \"\"\"\n        guesses: List[StreamInfo] = []\n\n        # Enhance the base guess with information based on the extension or mimetype\n        enhanced_guess = base_guess.copy_and_update()\n\n        # If there's an extension and no mimetype, try to guess the mimetype\n        if base_guess.mimetype is None and base_guess.extension is not None:\n            _m, _ = mimetypes.guess_type(\n                \"placeholder\" + base_guess.extension, strict=False\n            )\n            if _m is not None:\n                enhanced_guess = enhanced_guess.copy_and_update(mimetype=_m)\n\n        # If there's a mimetype and no extension, try to guess the extension\n        if base_guess.mimetype is not None and base_guess.extension is None:\n            _e = mimetypes.guess_all_extensions(base_guess.mimetype, strict=False)\n            if len(_e) > 0:\n                enhanced_guess = enhanced_guess.copy_and_update(extension=_e[0])\n\n        # Call magika to guess from the stream\n        cur_pos = file_stream.tell()\n        try:\n            result = self._magika.identify_stream(file_stream)\n            if result.status == \"ok\" and result.prediction.output.label != \"unknown\":\n                # If it's text, also guess the charset\n                charset = None\n                if result.prediction.output.is_text:\n                    # Read the first 4k to guess the charset\n                    file_stream.seek(cur_pos)\n                    stream_page = file_stream.read(4096)\n                    charset_result = charset_normalizer.from_bytes(stream_page).best()\n\n                    if charset_result is not None:\n                        charset = self._normalize_charset(charset_result.encoding)\n\n                # Normalize the first extension listed\n                guessed_extension = None\n                if len(result.prediction.output.extensions) > 0:\n                    guessed_extension = \".\" + result.prediction.output.extensions[0]\n\n                # Determine if the guess is compatible with the base guess\n                compatible = True\n                if (\n                    base_guess.mimetype is not None\n                    and base_guess.mimetype != result.prediction.output.mime_type\n                ):\n                    compatible = False\n\n                if (\n                    base_guess.extension is not None\n                    and base_guess.extension.lstrip(\".\")\n                    not in result.prediction.output.extensions\n                ):\n                    compatible = False\n\n                if (\n                    base_guess.charset is not None\n                    and self._normalize_charset(base_guess.charset) != charset\n                ):\n                    compatible = False\n\n                if compatible:\n                    # Add the compatible base guess\n                    guesses.append(\n                        StreamInfo(\n                            mimetype=base_guess.mimetype\n                            or result.prediction.output.mime_type,\n                            extension=base_guess.extension or guessed_extension,\n                            charset=base_guess.charset or charset,\n                            filename=base_guess.filename,\n                            local_path=base_guess.local_path,\n                            url=base_guess.url,\n                        )\n                    )\n                else:\n                    # The magika guess was incompatible with the base guess, so add both guesses\n                    guesses.append(enhanced_guess)\n                    guesses.append(\n                        StreamInfo(\n                            mimetype=result.prediction.output.mime_type,\n                            extension=guessed_extension,\n                            charset=charset,\n                            filename=base_guess.filename,\n                            local_path=base_guess.local_path,\n                            url=base_guess.url,\n                        )\n                    )\n            else:\n                # There were no other guesses, so just add the base guess\n                guesses.append(enhanced_guess)\n        finally:\n            file_stream.seek(cur_pos)\n\n        return guesses",
    "source": "github_repo:microsoft/markitdown",
    "file": "packages/markitdown/src/markitdown/_markitdown.py",
    "license": "MIT",
    "language": "python"
}