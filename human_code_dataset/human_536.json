{
    "code": "def _create_task_frame(\n\ttask: str,\n\tfirst_screenshot: str,\n\ttitle_font: ImageFont.FreeTypeFont,\n\tregular_font: ImageFont.FreeTypeFont,\n\tlogo: Image.Image | None = None,\n\tline_spacing: float = 1.5,\n) -> Image.Image:\n\t\"\"\"Create initial frame showing the task.\"\"\"\n\tfrom PIL import Image, ImageDraw, ImageFont\n\n\timg_data = base64.b64decode(first_screenshot)\n\ttemplate = Image.open(io.BytesIO(img_data))\n\timage = Image.new('RGB', template.size, (0, 0, 0))\n\tdraw = ImageDraw.Draw(image)\n\n\t# Calculate vertical center of image\n\tcenter_y = image.height // 2\n\n\t# Draw task text with dynamic font size based on task length\n\tmargin = 140  # Increased margin\n\tmax_width = image.width - (2 * margin)\n\n\t# Dynamic font size calculation based on task length\n\t# Start with base font size (regular + 16)\n\tbase_font_size = regular_font.size + 16\n\tmin_font_size = max(regular_font.size - 10, 16)  # Don't go below 16pt\n\tmax_font_size = base_font_size  # Cap at the base font size\n\n\t# Calculate dynamic font size based on text length and complexity\n\t# Longer texts get progressively smaller fonts\n\ttext_length = len(task)\n\tif text_length > 200:\n\t\t# For very long text, reduce font size logarithmically\n\t\tfont_size = max(base_font_size - int(10 * (text_length / 200)), min_font_size)\n\telse:\n\t\tfont_size = base_font_size\n\n\t# Try to create a larger font, but fall back to regular font if it fails\n\ttry:\n\t\tlarger_font = ImageFont.truetype(regular_font.path, font_size)  # type: ignore\n\texcept (OSError, AttributeError):\n\t\t# Fall back to regular font if .path is not available or font loading fails\n\t\tlarger_font = regular_font\n\n\t# Generate wrapped text with the calculated font size\n\twrapped_text = _wrap_text(task, larger_font, max_width)\n\n\t# Calculate line height with spacing\n\tline_height = larger_font.size * line_spacing\n\n\t# Split text into lines and draw with custom spacing\n\tlines = wrapped_text.split('\\n')\n\ttotal_height = line_height * len(lines)\n\n\t# Start position for first line\n\ttext_y = center_y - (total_height / 2) + 50  # Shifted down slightly\n\n\tfor line in lines:\n\t\t# Get line width for centering\n\t\tline_bbox = draw.textbbox((0, 0), line, font=larger_font)\n\t\ttext_x = (image.width - (line_bbox[2] - line_bbox[0])) // 2\n\n\t\tdraw.text(\n\t\t\t(text_x, text_y),\n\t\t\tline,\n\t\t\tfont=larger_font,\n\t\t\tfill=(255, 255, 255),\n\t\t)\n\t\ttext_y += line_height\n\n\t# Add logo if provided (top right corner)\n\tif logo:\n\t\tlogo_margin = 20\n\t\tlogo_x = image.width - logo.width - logo_margin\n\t\timage.paste(logo, (logo_x, logo_margin), logo if logo.mode == 'RGBA' else None)\n\n\treturn image",
    "source": "github_repo:browser-use/browser-use",
    "file": "browser_use/agent/gif.py",
    "license": "MIT",
    "language": "python"
}