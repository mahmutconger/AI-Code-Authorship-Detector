{
    "code": "class BrowserContextHelper:\n    def __init__(self, agent: \"BaseAgent\"):\n        self.agent = agent\n        self._current_base64_image: Optional[str] = None\n\n    async def get_browser_state(self) -> Optional[dict]:\n        browser_tool = self.agent.available_tools.get_tool(BrowserUseTool().name)\n        if not browser_tool:\n            browser_tool = self.agent.available_tools.get_tool(\n                SandboxBrowserTool().name\n            )\n        if not browser_tool or not hasattr(browser_tool, \"get_current_state\"):\n            logger.warning(\"BrowserUseTool not found or doesn't have get_current_state\")\n            return None\n        try:\n            result = await browser_tool.get_current_state()\n            if result.error:\n                logger.debug(f\"Browser state error: {result.error}\")\n                return None\n            if hasattr(result, \"base64_image\") and result.base64_image:\n                self._current_base64_image = result.base64_image\n            else:\n                self._current_base64_image = None\n            return json.loads(result.output)\n        except Exception as e:\n            logger.debug(f\"Failed to get browser state: {str(e)}\")\n            return None\n\n    async def format_next_step_prompt(self) -> str:\n        \"\"\"Gets browser state and formats the browser prompt.\"\"\"\n        browser_state = await self.get_browser_state()\n        url_info, tabs_info, content_above_info, content_below_info = \"\", \"\", \"\", \"\"\n        results_info = \"\"  # Or get from agent if needed elsewhere\n\n        if browser_state and not browser_state.get(\"error\"):\n            url_info = f\"\\n   URL: {browser_state.get('url', 'N/A')}\\n   Title: {browser_state.get('title', 'N/A')}\"\n            tabs = browser_state.get(\"tabs\", [])\n            if tabs:\n                tabs_info = f\"\\n   {len(tabs)} tab(s) available\"\n            pixels_above = browser_state.get(\"pixels_above\", 0)\n            pixels_below = browser_state.get(\"pixels_below\", 0)\n            if pixels_above > 0:\n                content_above_info = f\" ({pixels_above} pixels)\"\n            if pixels_below > 0:\n                content_below_info = f\" ({pixels_below} pixels)\"\n\n            if self._current_base64_image:\n                image_message = Message.user_message(\n                    content=\"Current browser screenshot:\",\n                    base64_image=self._current_base64_image,\n                )\n                self.agent.memory.add_message(image_message)\n                self._current_base64_image = None  # Consume the image after adding\n\n        return NEXT_STEP_PROMPT.format(\n            url_placeholder=url_info,\n            tabs_placeholder=tabs_info,\n            content_above_placeholder=content_above_info,\n            content_below_placeholder=content_below_info,\n            results_placeholder=results_info,\n        )\n\n    async def cleanup_browser(self):\n        browser_tool = self.agent.available_tools.get_tool(BrowserUseTool().name)\n        if browser_tool and hasattr(browser_tool, \"cleanup\"):\n            await browser_tool.cleanup()",
    "source": "github_repo:FoundationAgents/OpenManus",
    "file": "app/agent/browser.py",
    "license": "MIT",
    "language": "python"
}