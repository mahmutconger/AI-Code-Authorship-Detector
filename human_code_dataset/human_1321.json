{
    "code": "class DoclingParseV4DocumentBackend(PdfDocumentBackend):\n    def __init__(\n        self,\n        in_doc: \"InputDocument\",\n        path_or_stream: Union[BytesIO, Path],\n        options: PdfBackendOptions = PdfBackendOptions(),\n    ):\n        super().__init__(in_doc, path_or_stream, options)\n\n        password = (\n            self.options.password.get_secret_value() if self.options.password else None\n        )\n        with pypdfium2_lock:\n            self._pdoc = pdfium.PdfDocument(self.path_or_stream, password=password)\n        self.parser = DoclingPdfParser(loglevel=\"fatal\")\n        self.dp_doc: PdfDocument = self.parser.load(\n            path_or_stream=self.path_or_stream, password=password\n        )\n        success = self.dp_doc is not None\n\n        if not success:\n            raise RuntimeError(\n                f\"docling-parse v4 could not load document {self.document_hash}.\"\n            )\n\n    def page_count(self) -> int:\n        # return len(self._pdoc)  # To be replaced with docling-parse API\n\n        len_1 = len(self._pdoc)\n        len_2 = self.dp_doc.number_of_pages()\n\n        if len_1 != len_2:\n            _log.error(f\"Inconsistent number of pages: {len_1}!={len_2}\")\n\n        return len_2\n\n    def load_page(\n        self, page_no: int, create_words: bool = True, create_textlines: bool = True\n    ) -> DoclingParseV4PageBackend:\n        with pypdfium2_lock:\n            ppage = self._pdoc[page_no]\n\n        return DoclingParseV4PageBackend(\n            dp_doc=self.dp_doc,\n            page_obj=ppage,\n            page_no=page_no,\n            create_words=create_words,\n            create_textlines=create_textlines,\n        )\n\n    def is_valid(self) -> bool:\n        return self.page_count() > 0\n\n    def unload(self):\n        super().unload()\n        # Unload docling-parse document first\n        if self.dp_doc is not None:\n            self.dp_doc.unload()\n            self.dp_doc = None\n\n        # Then close pypdfium2 document with proper locking\n        if self._pdoc is not None:\n            with pypdfium2_lock:\n                try:\n                    self._pdoc.close()\n                except Exception:\n                    # Ignore cleanup errors\n                    pass\n            self._pdoc = None",
    "source": "github_repo:docling-project/docling",
    "file": "docling/backend/docling_parse_v4_backend.py",
    "license": "MIT",
    "language": "python"
}