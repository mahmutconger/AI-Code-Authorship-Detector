{
    "code": "class GenAndImproveImageAction(Action):\n    save_image: bool = True\n\n    async def generate_image(self, prompt: str) -> Image:\n        imgs = await self.llm.gen_image(model=\"dall-e-3\", prompt=prompt)\n        return imgs[0]\n\n    async def refine_prompt(self, old_prompt: str, image: Image) -> str:\n        msg = (\n            f\"You are a creative painter, with the given generated image and old prompt: {old_prompt}, \"\n            f\"please refine the prompt and generate new one. Just output the new prompt.\"\n        )\n        b64_img = encode_image(image)\n        new_prompt = await self.llm.aask(msg=msg, images=[b64_img])\n        return new_prompt\n\n    async def evaluate_images(self, old_prompt: str, images: list[Image]) -> str:\n        msg = (\n            \"With the prompt and two generated image, to judge if the second one is better than the first one. \"\n            \"If so, just output True else output False\"\n        )\n        b64_imgs = [encode_image(img) for img in images]\n        res = await self.llm.aask(msg=msg, images=b64_imgs)\n        return res\n\n    async def run(self, messages: list[Message]) -> str:\n        prompt = messages[-1].content\n\n        old_img: Image = await self.generate_image(prompt)\n        new_prompt = await self.refine_prompt(old_prompt=prompt, image=old_img)\n        logger.info(f\"original prompt: {prompt}\")\n        logger.info(f\"refined prompt: {new_prompt}\")\n        new_img: Image = await self.generate_image(new_prompt)\n        if self.save_image:\n            old_img.save(\"./img_by-dall-e_old.png\")\n            new_img.save(\"./img_by-dall-e_new.png\")\n        res = await self.evaluate_images(old_prompt=prompt, images=[old_img, new_img])\n        opinion = f\"The second generated image is better than the first one: {res}\"\n        logger.info(f\"evaluate opinion: {opinion}\")\n        return opinion",
    "source": "github_repo:FoundationAgents/MetaGPT",
    "file": "examples/dalle_gpt4v_agent.py",
    "license": "MIT",
    "language": "python"
}