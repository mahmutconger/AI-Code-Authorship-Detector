{
    "code": "class Alpha158(AlphaDataset):\n    \"\"\"158 basic factors from Qlib\"\"\"\n\n    def __init__(\n        self,\n        df: pl.DataFrame,\n        train_period: tuple[str, str],\n        valid_period: tuple[str, str],\n        test_period: tuple[str, str]\n    ) -> None:\n        \"\"\"Constructor\"\"\"\n        super().__init__(\n            df=df,\n            train_period=train_period,\n            valid_period=valid_period,\n            test_period=test_period,\n        )\n\n        # Candlestick pattern features\n        self.add_feature(\"kmid\", \"(close - open) / open\")\n        self.add_feature(\"klen\", \"(high - low) / open\")\n        self.add_feature(\"kmid_2\", \"(close - open) / (high - low + 1e-12)\")\n        self.add_feature(\"kup\", \"(high - ts_greater(open, close)) / open\")\n        self.add_feature(\"kup_2\", \"(high - ts_greater(open, close)) / (high - low + 1e-12)\")\n        self.add_feature(\"klow\", \"(ts_less(open, close) - low) / open\")\n        self.add_feature(\"klow_2\", \"((ts_less(open, close) - low) / (high - low + 1e-12))\")\n        self.add_feature(\"ksft\", \"(close * 2 - high - low) / open\")\n        self.add_feature(\"ksft_2\", \"(close * 2 - high - low) / (high - low + 1e-12)\")\n\n        # Price change features\n        for field in [\"open\", \"high\", \"low\", \"vwap\"]:\n            self.add_feature(f\"{field}_0\", f\"{field} / close\")\n\n        # Time series features\n        windows: list[int] = [5, 10, 20, 30, 60]\n\n        for w in windows:\n            self.add_feature(f\"roc_{w}\", f\"ts_delay(close, {w}) / close\")\n\n        for w in windows:\n            self.add_feature(f\"ma_{w}\", f\"ts_mean(close, {w}) / close\")\n\n        for w in windows:\n            self.add_feature(f\"std_{w}\", f\"ts_std(close, {w}) / close\")\n\n        for w in windows:\n            self.add_feature(f\"beta_{w}\", f\"ts_slope(close, {w}) / close\")\n\n        for w in windows:\n            self.add_feature(f\"rsqr_{w}\", f\"ts_rsquare(close, {w})\")\n\n        for w in windows:\n            self.add_feature(f\"resi_{w}\", f\"ts_resi(close, {w}) / close\")\n\n        for w in windows:\n            self.add_feature(f\"max_{w}\", f\"ts_max(high, {w}) / close\")\n\n        for w in windows:\n            self.add_feature(f\"min_{w}\", f\"ts_min(low, {w}) / close\")\n\n        for w in windows:\n            self.add_feature(f\"qtlu_{w}\", f\"ts_quantile(close, {w}, 0.8) / close\")\n\n        for w in windows:\n            self.add_feature(f\"qtld_{w}\", f\"ts_quantile(close, {w}, 0.2) / close\")\n\n        for w in windows:\n            self.add_feature(f\"rank_{w}\", f\"ts_rank(close, {w})\")\n\n        for w in windows:\n            self.add_feature(f\"rsv_{w}\", f\"(close - ts_min(low, {w})) / (ts_max(high, {w}) - ts_min(low, {w}) + 1e-12)\")\n\n        for w in windows:\n            self.add_feature(f\"imax_{w}\", f\"ts_argmax(high, {w}) / {w}\")\n\n        for w in windows:\n            self.add_feature(f\"imin_{w}\", f\"ts_argmin(low, {w}) / {w}\")\n\n        for w in windows:\n            self.add_feature(f\"imxd_{w}\", f\"(ts_argmax(high, {w}) - ts_argmin(low, {w})) / {w}\")\n\n        for w in windows:\n            self.add_feature(f\"corr_{w}\", f\"ts_corr(close, ts_log(volume + 1), {w})\")\n\n        for w in windows:\n            self.add_feature(f\"cord_{w}\", f\"ts_corr(close / ts_delay(close, 1), ts_log(volume / ts_delay(volume, 1) + 1), {w})\")\n\n        for w in windows:\n            self.add_feature(f\"cntp_{w}\", f\"ts_mean(close > ts_delay(close, 1), {w})\")\n\n        for w in windows:\n            self.add_feature(f\"cntn_{w}\", f\"ts_mean(close < ts_delay(close, 1), {w})\")\n\n        for w in windows:\n            self.add_feature(f\"cntd_{w}\", f\"ts_mean(close > ts_delay(close, 1), {w}) - ts_mean(close < ts_delay(close, 1), {w})\")\n\n        for w in windows:\n            self.add_feature(f\"sump_{w}\", f\"ts_sum(ts_greater(close - ts_delay(close, 1), 0), {w}) / (ts_sum(ts_abs(close - ts_delay(close, 1)), {w}) + 1e-12)\")\n\n        for w in windows:\n            self.add_feature(f\"sumn_{w}\", f\"ts_sum(ts_greater(ts_delay(close, 1) - close, 0), {w}) / (ts_sum(ts_abs(close - ts_delay(close, 1)), {w}) + 1e-12)\")\n\n        for w in windows:\n            self.add_feature(f\"sumd_{w}\", f\"(ts_sum(ts_greater(close - ts_delay(close, 1), 0), {w}) - ts_sum(ts_greater(ts_delay(close, 1) - close, 0), {w})) / (ts_sum(ts_abs(close - ts_delay(close, 1)), {w}) + 1e-12)\")\n\n        for w in windows:\n            self.add_feature(f\"vma_{w}\", f\"ts_mean(volume, {w}) / (volume + 1e-12)\")\n\n        for w in windows:\n            self.add_feature(f\"vstd_{w}\", f\"ts_std(volume, {w}) / (volume + 1e-12)\")\n\n        for w in windows:\n            self.add_feature(f\"wvma_{w}\", f\"ts_std(ts_abs(close / ts_delay(close, 1) - 1) * volume, {w}) / (ts_mean(ts_abs(close / ts_delay(close, 1) - 1) * volume, {w}) + 1e-12)\")\n\n        for w in windows:\n            self.add_feature(f\"vsump_{w}\", f\"ts_sum(ts_greater(volume - ts_delay(volume, 1), 0), {w}) / (ts_sum(ts_abs(volume - ts_delay(volume, 1)), {w}) + 1e-12)\")\n\n        for w in windows:\n            self.add_feature(f\"vsumn_{w}\", f\"ts_sum(ts_greater(ts_delay(volume, 1) - volume, 0), {w}) / (ts_sum(ts_abs(volume - ts_delay(volume, 1)), {w}) + 1e-12)\")\n\n        for w in windows:\n            self.add_feature(f\"vsumd_{w}\", f\"(ts_sum(ts_greater(volume - ts_delay(volume, 1), 0), {w}) - ts_sum(ts_greater(ts_delay(volume, 1) - volume, 0), {w})) / (ts_sum(ts_abs(volume - ts_delay(volume, 1)), {w}) + 1e-12)\")\n\n        # Set label\n        self.set_label(\"ts_delay(close, -3) / ts_delay(close, -1) - 1\")",
    "source": "github_repo:vnpy/vnpy",
    "file": "vnpy/alpha/dataset/datasets/alpha_158.py",
    "license": "MIT",
    "language": "python"
}