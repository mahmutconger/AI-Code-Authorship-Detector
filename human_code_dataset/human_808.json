{
    "code": "class TestMessaging:\n  def setUp(self):\n    # TODO: ZMQ tests are too slow; all sleeps will need to be\n    # replaced with logic to block on the necessary condition\n    if \"ZMQ\" in os.environ:\n      pytest.skip()\n\n    # ZMQ pub socket takes too long to die\n    # sleep to prevent multiple publishers error between tests\n    zmq_sleep()\n\n  @parameterized.expand(events)\n  def test_new_message(self, evt):\n    try:\n      msg = messaging.new_message(evt)\n    except capnp.lib.capnp.KjException:\n      msg = messaging.new_message(evt, random.randrange(200))\n    assert (time.monotonic() - msg.logMonoTime) < 0.1\n    assert not msg.valid\n    assert evt == msg.which()\n\n  @parameterized.expand(events)\n  def test_pub_sock(self, evt):\n    messaging.pub_sock(evt)\n\n  @parameterized.expand(events)\n  def test_sub_sock(self, evt):\n    messaging.sub_sock(evt)\n\n  @parameterized.expand([\n    (messaging.drain_sock, capnp._DynamicStructReader),\n    (messaging.drain_sock_raw, bytes),\n  ])\n  def test_drain_sock(self, func, expected_type):\n    sock = \"carState\"\n    pub_sock = messaging.pub_sock(sock)\n    sub_sock = messaging.sub_sock(sock, timeout=1000)\n    zmq_sleep()\n\n    # no wait and no msgs in queue\n    msgs = func(sub_sock)\n    assert isinstance(msgs, list)\n    assert len(msgs) == 0\n\n    # no wait but msgs are queued up\n    num_msgs = random.randrange(3, 10)\n    for _ in range(num_msgs):\n      pub_sock.send(messaging.new_message(sock).to_bytes())\n    time.sleep(0.1)\n    msgs = func(sub_sock)\n    assert isinstance(msgs, list)\n    assert all(isinstance(msg, expected_type) for msg in msgs)\n    assert len(msgs) == num_msgs\n\n  def test_recv_sock(self):\n    sock = \"carState\"\n    pub_sock = messaging.pub_sock(sock)\n    sub_sock = messaging.sub_sock(sock, timeout=100)\n    zmq_sleep()\n\n    # no wait and no msg in queue, socket should timeout\n    recvd = messaging.recv_sock(sub_sock)\n    assert recvd is None\n\n    # no wait and one msg in queue\n    msg = random_carstate()\n    pub_sock.send(msg.to_bytes())\n    time.sleep(0.01)\n    recvd = messaging.recv_sock(sub_sock)\n    assert isinstance(recvd, capnp._DynamicStructReader)\n    # https://github.com/python/mypy/issues/13038\n    assert_carstate(msg.carState, recvd.carState)\n\n  def test_recv_one(self):\n    sock = \"carState\"\n    pub_sock = messaging.pub_sock(sock)\n    sub_sock = messaging.sub_sock(sock, timeout=1000)\n    zmq_sleep()\n\n    # no msg in queue, socket should timeout\n    recvd = messaging.recv_one(sub_sock)\n    assert recvd is None\n\n    # one msg in queue\n    msg = random_carstate()\n    pub_sock.send(msg.to_bytes())\n    recvd = messaging.recv_one(sub_sock)\n    assert isinstance(recvd, capnp._DynamicStructReader)\n    assert_carstate(msg.carState, recvd.carState)\n\n  @pytest.mark.xfail(condition=\"ZMQ\" in os.environ, reason='ZMQ detected')\n  def test_recv_one_or_none(self):\n    sock = \"carState\"\n    pub_sock = messaging.pub_sock(sock)\n    sub_sock = messaging.sub_sock(sock)\n    zmq_sleep()\n\n    # no msg in queue, socket shouldn't block\n    recvd = messaging.recv_one_or_none(sub_sock)\n    assert recvd is None\n\n    # one msg in queue\n    msg = random_carstate()\n    pub_sock.send(msg.to_bytes())\n    recvd = messaging.recv_one_or_none(sub_sock)\n    assert isinstance(recvd, capnp._DynamicStructReader)\n    assert_carstate(msg.carState, recvd.carState)\n\n  def test_recv_one_retry(self):\n    sock = \"carState\"\n    sock_timeout = 0.1\n    pub_sock = messaging.pub_sock(sock)\n    sub_sock = messaging.sub_sock(sock, timeout=round(sock_timeout*1000))\n    zmq_sleep()\n\n    # this test doesn't work with ZMQ since multiprocessing interrupts it\n    if \"ZMQ\" not in os.environ:\n      # wait 5 socket timeouts and make sure it's still retrying\n      p = multiprocessing.Process(target=messaging.recv_one_retry, args=(sub_sock,))\n      p.start()\n      time.sleep(sock_timeout*5)\n      assert p.is_alive()\n      p.terminate()\n\n    # wait 5 socket timeouts before sending\n    msg = random_carstate()\n    start_time = time.monotonic()\n    delayed_send(sock_timeout*5, pub_sock, msg.to_bytes())\n    recvd = messaging.recv_one_retry(sub_sock)\n    assert (time.monotonic() - start_time) >= sock_timeout*5\n    assert isinstance(recvd, capnp._DynamicStructReader)\n    assert_carstate(msg.carState, recvd.carState)",
    "source": "github_repo:commaai/openpilot",
    "file": "cereal/messaging/tests/test_messaging.py",
    "license": "MIT",
    "language": "python"
}