{
    "code": "def create_history_gif(\n\ttask: str,\n\thistory: AgentHistoryList,\n\t#\n\toutput_path: str = 'agent_history.gif',\n\tduration: int = 3000,\n\tshow_goals: bool = True,\n\tshow_task: bool = True,\n\tshow_logo: bool = False,\n\tfont_size: int = 40,\n\ttitle_font_size: int = 56,\n\tgoal_font_size: int = 44,\n\tmargin: int = 40,\n\tline_spacing: float = 1.5,\n) -> None:\n\t\"\"\"Create a GIF from the agent's history with overlaid task and goal text.\"\"\"\n\tif not history.history:\n\t\tlogger.warning('No history to create GIF from')\n\t\treturn\n\n\tfrom PIL import Image, ImageFont\n\n\timages = []\n\n\t# if history is empty, we can't create a gif\n\tif not history.history:\n\t\tlogger.warning('No history to create GIF from')\n\t\treturn\n\n\t# Get all screenshots from history (including None placeholders)\n\tscreenshots = history.screenshots(return_none_if_not_screenshot=True)\n\n\tif not screenshots:\n\t\tlogger.warning('No screenshots found in history')\n\t\treturn\n\n\t# Find the first non-placeholder screenshot\n\t# A screenshot is considered a placeholder if:\n\t# 1. It's the exact 4px placeholder for about:blank pages, OR\n\t# 2. It comes from a new tab page (chrome://newtab/, about:blank, etc.)\n\tfirst_real_screenshot = None\n\tfor screenshot in screenshots:\n\t\tif screenshot and screenshot != PLACEHOLDER_4PX_SCREENSHOT:\n\t\t\tfirst_real_screenshot = screenshot\n\t\t\tbreak\n\n\tif not first_real_screenshot:\n\t\tlogger.warning('No valid screenshots found (all are placeholders or from new tab pages)')\n\t\treturn\n\n\t# Try to load nicer fonts\n\ttry:\n\t\t# Try different font options in order of preference\n\t\t# ArialUni is a font that comes with Office and can render most non-alphabet characters\n\t\tfont_options = [\n\t\t\t'PingFang',\n\t\t\t'STHeiti Medium',\n\t\t\t'Microsoft YaHei',  # 微软雅黑\n\t\t\t'SimHei',  # 黑体\n\t\t\t'SimSun',  # 宋体\n\t\t\t'Noto Sans CJK SC',  # 思源黑体\n\t\t\t'WenQuanYi Micro Hei',  # 文泉驿微米黑\n\t\t\t'Helvetica',\n\t\t\t'Arial',\n\t\t\t'DejaVuSans',\n\t\t\t'Verdana',\n\t\t]\n\t\tfont_loaded = False\n\n\t\tfor font_name in font_options:\n\t\t\ttry:\n\t\t\t\tif platform.system() == 'Windows':\n\t\t\t\t\t# Need to specify the abs font path on Windows\n\t\t\t\t\tfont_name = os.path.join(CONFIG.WIN_FONT_DIR, font_name + '.ttf')\n\t\t\t\tregular_font = ImageFont.truetype(font_name, font_size)\n\t\t\t\ttitle_font = ImageFont.truetype(font_name, title_font_size)\n\t\t\t\tgoal_font = ImageFont.truetype(font_name, goal_font_size)\n\t\t\t\tfont_loaded = True\n\t\t\t\tbreak\n\t\t\texcept OSError:\n\t\t\t\tcontinue\n\n\t\tif not font_loaded:\n\t\t\traise OSError('No preferred fonts found')\n\n\texcept OSError:\n\t\tregular_font = ImageFont.load_default()\n\t\ttitle_font = ImageFont.load_default()\n\n\t\tgoal_font = regular_font\n\n\t# Load logo if requested\n\tlogo = None\n\tif show_logo:\n\t\ttry:\n\t\t\tlogo = Image.open('./static/browser-use.png')\n\t\t\t# Resize logo to be small (e.g., 40px height)\n\t\t\tlogo_height = 150\n\t\t\taspect_ratio = logo.width / logo.height\n\t\t\tlogo_width = int(logo_height * aspect_ratio)\n\t\t\tlogo = logo.resize((logo_width, logo_height), Image.Resampling.LANCZOS)\n\t\texcept Exception as e:\n\t\t\tlogger.warning(f'Could not load logo: {e}')\n\n\t# Create task frame if requested\n\tif show_task and task:\n\t\t# Find the first non-placeholder screenshot for the task frame\n\t\tfirst_real_screenshot = None\n\t\tfor item in history.history:\n\t\t\tscreenshot_b64 = item.state.get_screenshot()\n\t\t\tif screenshot_b64 and screenshot_b64 != PLACEHOLDER_4PX_SCREENSHOT:\n\t\t\t\tfirst_real_screenshot = screenshot_b64\n\t\t\t\tbreak\n\n\t\tif first_real_screenshot:\n\t\t\ttask_frame = _create_task_frame(\n\t\t\t\ttask,\n\t\t\t\tfirst_real_screenshot,\n\t\t\t\ttitle_font,  # type: ignore\n\t\t\t\tregular_font,  # type: ignore\n\t\t\t\tlogo,\n\t\t\t\tline_spacing,\n\t\t\t)\n\t\t\timages.append(task_frame)\n\t\telse:\n\t\t\tlogger.warning('No real screenshots found for task frame, skipping task frame')\n\n\t# Process each history item with its corresponding screenshot\n\tfor i, (item, screenshot) in enumerate(zip(history.history, screenshots), 1):\n\t\tif not screenshot:\n\t\t\tcontinue\n\n\t\t# Skip placeholder screenshots from about:blank pages\n\t\t# These are 4x4 white PNGs encoded as a specific base64 string\n\t\tif screenshot == PLACEHOLDER_4PX_SCREENSHOT:\n\t\t\tlogger.debug(f'Skipping placeholder screenshot from about:blank page at step {i}')\n\t\t\tcontinue\n\n\t\t# Skip screenshots from new tab pages\n\t\tfrom browser_use.utils import is_new_tab_page\n\n\t\tif is_new_tab_page(item.state.url):\n\t\t\tlogger.debug(f'Skipping screenshot from new tab page ({item.state.url}) at step {i}')\n\t\t\tcontinue\n\n\t\t# Convert base64 screenshot to PIL Image\n\t\timg_data = base64.b64decode(screenshot)\n\t\timage = Image.open(io.BytesIO(img_data))\n\n\t\tif show_goals and item.model_output:\n\t\t\timage = _add_overlay_to_image(\n\t\t\t\timage=image,\n\t\t\t\tstep_number=i,\n\t\t\t\tgoal_text=item.model_output.current_state.next_goal,\n\t\t\t\tregular_font=regular_font,  # type: ignore\n\t\t\t\ttitle_font=title_font,  # type: ignore\n\t\t\t\tmargin=margin,\n\t\t\t\tlogo=logo,\n\t\t\t)\n\n\t\timages.append(image)\n\n\tif images:\n\t\t# Save the GIF\n\t\timages[0].save(\n\t\t\toutput_path,\n\t\t\tsave_all=True,\n\t\t\tappend_images=images[1:],\n\t\t\tduration=duration,\n\t\t\tloop=0,\n\t\t\toptimize=False,\n\t\t)\n\t\tlogger.info(f'Created GIF at {output_path}')\n\telse:\n\t\tlogger.warning('No images found in history to create GIF')",
    "source": "github_repo:browser-use/browser-use",
    "file": "browser_use/agent/gif.py",
    "license": "MIT",
    "language": "python"
}