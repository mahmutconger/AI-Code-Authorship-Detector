{
    "code": "class SubMaster:\n  def __init__(self, services: List[str], poll: Optional[str] = None,\n               ignore_alive: Optional[List[str]] = None, ignore_avg_freq: Optional[List[str]] = None,\n               ignore_valid: Optional[List[str]] = None, addr: str = \"127.0.0.1\", frequency: Optional[float] = None):\n    self.frame = -1\n    self.services = services\n    self.seen = {s: False for s in services}\n    self.updated = {s: False for s in services}\n    self.recv_time = {s: 0. for s in services}\n    self.recv_frame = {s: 0 for s in services}\n    self.sock = {}\n    self.data = {}\n    self.logMonoTime = {s: 0 for s in services}\n\n    # zero-frequency / on-demand services are always alive and presumed valid; all others must pass checks\n    on_demand = {s: SERVICE_LIST[s].frequency <= 1e-5 for s in services}\n    self.static_freq_services = set(s for s in services if not on_demand[s])\n    self.alive = {s: on_demand[s] for s in services}\n    self.freq_ok = {s: on_demand[s] for s in services}\n    self.valid = {s: on_demand[s] for s in services}\n\n    self.freq_tracker: Dict[str, FrequencyTracker] = {}\n    self.poller = Poller()\n    polled_services = set([poll, ] if poll is not None else services)\n    self.non_polled_services = set(services) - polled_services\n\n    self.ignore_average_freq = [] if ignore_avg_freq is None else ignore_avg_freq\n    self.ignore_alive = [] if ignore_alive is None else ignore_alive\n    self.ignore_valid = [] if ignore_valid is None else ignore_valid\n\n    self.simulation = bool(int(os.getenv(\"SIMULATION\", \"0\")))\n\n    # if freq and poll aren't specified, assume the max to be conservative\n    assert frequency is None or poll is None, \"Do not specify 'frequency' - frequency of the polled service will be used.\"\n    self.update_freq = frequency or max([SERVICE_LIST[s].frequency for s in polled_services])\n\n    for s in services:\n      p = self.poller if s not in self.non_polled_services else None\n      self.sock[s] = sub_sock(s, poller=p, addr=addr, conflate=True)\n\n      try:\n        data = new_message(s)\n      except capnp.lib.capnp.KjException:\n        data = new_message(s, 0) # lists\n\n      self.data[s] = getattr(data.as_reader(), s)\n      self.freq_tracker[s] = FrequencyTracker(SERVICE_LIST[s].frequency, self.update_freq, s == poll)\n\n  def __getitem__(self, s: str) -> capnp.lib.capnp._DynamicStructReader:\n    return self.data[s]\n\n  def _check_avg_freq(self, s: str) -> bool:\n    return SERVICE_LIST[s].frequency > 0.99 and (s not in self.ignore_average_freq) and (s not in self.ignore_alive)\n\n  def update(self, timeout: int = 100) -> None:\n    msgs = []\n    for sock in self.poller.poll(timeout):\n      msgs.append(recv_one_or_none(sock))\n\n    # non-blocking receive for non-polled sockets\n    for s in self.non_polled_services:\n      msgs.append(recv_one_or_none(self.sock[s]))\n    self.update_msgs(time.monotonic(), msgs)\n\n  def update_msgs(self, cur_time: float, msgs: List[capnp.lib.capnp._DynamicStructReader]) -> None:\n    self.frame += 1\n    self.updated = dict.fromkeys(self.services, False)\n    for msg in msgs:\n      if msg is None:\n        continue\n\n      s = msg.which()\n      self.seen[s] = True\n      self.updated[s] = True\n\n      self.freq_tracker[s].record_recv_time(cur_time)\n      self.recv_time[s] = cur_time\n      self.recv_frame[s] = self.frame\n      self.data[s] = getattr(msg, s)\n      self.logMonoTime[s] = msg.logMonoTime\n      self.valid[s] = msg.valid\n\n    for s in self.static_freq_services:\n      # alive if delay is within 10x the expected frequency; checks relaxed in simulator\n      self.alive[s] = (cur_time - self.recv_time[s]) < (10. / SERVICE_LIST[s].frequency) or (self.seen[s] and self.simulation)\n      self.freq_ok[s] = self.freq_tracker[s].valid or self.simulation\n\n  def all_alive(self, service_list: Optional[List[str]] = None) -> bool:\n    return all(self.alive[s] for s in (service_list or self.services) if s not in self.ignore_alive)\n\n  def all_freq_ok(self, service_list: Optional[List[str]] = None) -> bool:\n    return all(self.freq_ok[s] for s in (service_list or self.services) if self._check_avg_freq(s))\n\n  def all_valid(self, service_list: Optional[List[str]] = None) -> bool:\n    return all(self.valid[s] for s in (service_list or self.services) if s not in self.ignore_valid)\n\n  def all_checks(self, service_list: Optional[List[str]] = None) -> bool:\n    return self.all_alive(service_list) and self.all_freq_ok(service_list) and self.all_valid(service_list)",
    "source": "github_repo:commaai/openpilot",
    "file": "cereal/messaging/__init__.py",
    "license": "MIT",
    "language": "python"
}