{
    "code": "def reply_text(self, session: AliQwenSession, retry_count=0) -> dict:\n        \"\"\"\n        call bailian's ChatCompletion to get the answer\n        :param session: a conversation session\n        :param retry_count: retry count\n        :return: {}\n        \"\"\"\n        try:\n            prompt, history = self.convert_messages_format(session.messages)\n            self.update_api_key_if_expired()\n            # NOTE 阿里百炼的call()函数未提供temperature参数，考虑到temperature和top_p参数作用相同，取两者较小的值作为top_p参数传入，详情见文档 https://help.aliyun.com/document_detail/2587502.htm\n            response = broadscope_bailian.Completions().call(app_id=self.app_id(), prompt=prompt, history=history, top_p=min(self.temperature(), self.top_p()))\n            completion_content = self.get_completion_content(response, self.node_id())\n            completion_tokens, total_tokens = self.calc_tokens(session.messages, completion_content)\n            return {\n                \"total_tokens\": total_tokens,\n                \"completion_tokens\": completion_tokens,\n                \"content\": completion_content,\n            }\n        except Exception as e:\n            need_retry = retry_count < 2\n            result = {\"completion_tokens\": 0, \"content\": \"我现在有点累了，等会再来吧\"}\n            if isinstance(e, openai.error.RateLimitError):\n                logger.warn(\"[QWEN] RateLimitError: {}\".format(e))\n                result[\"content\"] = \"提问太快啦，请休息一下再问我吧\"\n                if need_retry:\n                    time.sleep(20)\n            elif isinstance(e, openai.error.Timeout):\n                logger.warn(\"[QWEN] Timeout: {}\".format(e))\n                result[\"content\"] = \"我没有收到你的消息\"\n                if need_retry:\n                    time.sleep(5)\n            elif isinstance(e, openai.error.APIError):\n                logger.warn(\"[QWEN] Bad Gateway: {}\".format(e))\n                result[\"content\"] = \"请再问我一次\"\n                if need_retry:\n                    time.sleep(10)\n            elif isinstance(e, openai.error.APIConnectionError):\n                logger.warn(\"[QWEN] APIConnectionError: {}\".format(e))\n                need_retry = False\n                result[\"content\"] = \"我连接不到你的网络\"\n            else:\n                logger.exception(\"[QWEN] Exception: {}\".format(e))\n                need_retry = False\n                self.sessions.clear_session(session.session_id)\n\n            if need_retry:\n                logger.warn(\"[QWEN] 第{}次重试\".format(retry_count + 1))\n                return self.reply_text(session, retry_count + 1)\n            else:\n                return result",
    "source": "github_repo:zhayujie/chatgpt-on-wechat",
    "file": "bot/ali/ali_qwen_bot.py",
    "license": "MIT",
    "language": "python"
}