{
    "code": "def download_and_extract_template(project_path: Path, ai_assistant: str, script_type: str, is_current_dir: bool = False, *, verbose: bool = True, tracker: StepTracker | None = None, client: httpx.Client = None, debug: bool = False, github_token: str = None) -> Path:\n    \"\"\"Download the latest release and extract it to create a new project.\n    Returns project_path. Uses tracker if provided (with keys: fetch, download, extract, cleanup)\n    \"\"\"\n    current_dir = Path.cwd()\n\n    if tracker:\n        tracker.start(\"fetch\", \"contacting GitHub API\")\n    try:\n        zip_path, meta = download_template_from_github(\n            ai_assistant,\n            current_dir,\n            script_type=script_type,\n            verbose=verbose and tracker is None,\n            show_progress=(tracker is None),\n            client=client,\n            debug=debug,\n            github_token=github_token\n        )\n        if tracker:\n            tracker.complete(\"fetch\", f\"release {meta['release']} ({meta['size']:,} bytes)\")\n            tracker.add(\"download\", \"Download template\")\n            tracker.complete(\"download\", meta['filename'])\n    except Exception as e:\n        if tracker:\n            tracker.error(\"fetch\", str(e))\n        else:\n            if verbose:\n                console.print(f\"[red]Error downloading template:[/red] {e}\")\n        raise\n\n    if tracker:\n        tracker.add(\"extract\", \"Extract template\")\n        tracker.start(\"extract\")\n    elif verbose:\n        console.print(\"Extracting template...\")\n\n    try:\n        if not is_current_dir:\n            project_path.mkdir(parents=True)\n\n        with zipfile.ZipFile(zip_path, 'r') as zip_ref:\n            zip_contents = zip_ref.namelist()\n            if tracker:\n                tracker.start(\"zip-list\")\n                tracker.complete(\"zip-list\", f\"{len(zip_contents)} entries\")\n            elif verbose:\n                console.print(f\"[cyan]ZIP contains {len(zip_contents)} items[/cyan]\")\n\n            if is_current_dir:\n                with tempfile.TemporaryDirectory() as temp_dir:\n                    temp_path = Path(temp_dir)\n                    zip_ref.extractall(temp_path)\n\n                    extracted_items = list(temp_path.iterdir())\n                    if tracker:\n                        tracker.start(\"extracted-summary\")\n                        tracker.complete(\"extracted-summary\", f\"temp {len(extracted_items)} items\")\n                    elif verbose:\n                        console.print(f\"[cyan]Extracted {len(extracted_items)} items to temp location[/cyan]\")\n\n                    source_dir = temp_path\n                    if len(extracted_items) == 1 and extracted_items[0].is_dir():\n                        source_dir = extracted_items[0]\n                        if tracker:\n                            tracker.add(\"flatten\", \"Flatten nested directory\")\n                            tracker.complete(\"flatten\")\n                        elif verbose:\n                            console.print(f\"[cyan]Found nested directory structure[/cyan]\")\n\n                    for item in source_dir.iterdir():\n                        dest_path = project_path / item.name\n                        if item.is_dir():\n                            if dest_path.exists():\n                                if verbose and not tracker:\n                                    console.print(f\"[yellow]Merging directory:[/yellow] {item.name}\")\n                                for sub_item in item.rglob('*'):\n                                    if sub_item.is_file():\n                                        rel_path = sub_item.relative_to(item)\n                                        dest_file = dest_path / rel_path\n                                        dest_file.parent.mkdir(parents=True, exist_ok=True)\n                                        # Special handling for .vscode/settings.json - merge instead of overwrite\n                                        if dest_file.name == \"settings.json\" and dest_file.parent.name == \".vscode\":\n                                            handle_vscode_settings(sub_item, dest_file, rel_path, verbose, tracker)\n                                        else:\n                                            shutil.copy2(sub_item, dest_file)\n                            else:\n                                shutil.copytree(item, dest_path)\n                        else:\n                            if dest_path.exists() and verbose and not tracker:\n                                console.print(f\"[yellow]Overwriting file:[/yellow] {item.name}\")\n                            shutil.copy2(item, dest_path)\n                    if verbose and not tracker:\n                        console.print(f\"[cyan]Template files merged into current directory[/cyan]\")\n            else:\n                zip_ref.extractall(project_path)\n\n                extracted_items = list(project_path.iterdir())\n                if tracker:\n                    tracker.start(\"extracted-summary\")\n                    tracker.complete(\"extracted-summary\", f\"{len(extracted_items)} top-level items\")\n                elif verbose:\n                    console.print(f\"[cyan]Extracted {len(extracted_items)} items to {project_path}:[/cyan]\")\n                    for item in extracted_items:\n                        console.print(f\"  - {item.name} ({'dir' if item.is_dir() else 'file'})\")\n\n                if len(extracted_items) == 1 and extracted_items[0].is_dir():\n                    nested_dir = extracted_items[0]\n                    temp_move_dir = project_path.parent / f\"{project_path.name}_temp\"\n\n                    shutil.move(str(nested_dir), str(temp_move_dir))\n\n                    project_path.rmdir()\n\n                    shutil.move(str(temp_move_dir), str(project_path))\n                    if tracker:\n                        tracker.add(\"flatten\", \"Flatten nested directory\")\n                        tracker.complete(\"flatten\")\n                    elif verbose:\n                        console.print(f\"[cyan]Flattened nested directory structure[/cyan]\")\n\n    except Exception as e:\n        if tracker:\n            tracker.error(\"extract\", str(e))\n        else:\n            if verbose:\n                console.print(f\"[red]Error extracting template:[/red] {e}\")\n                if debug:\n                    console.print(Panel(str(e), title=\"Extraction Error\", border_style=\"red\"))\n\n        if not is_current_dir and project_path.exists():\n            shutil.rmtree(project_path)\n        raise typer.Exit(1)\n    else:\n        if tracker:\n            tracker.complete(\"extract\")\n    finally:\n        if tracker:\n            tracker.add(\"cleanup\", \"Remove temporary archive\")\n\n        if zip_path.exists():\n            zip_path.unlink()\n            if tracker:\n                tracker.complete(\"cleanup\")\n            elif verbose:\n                console.print(f\"Cleaned up: {zip_path.name}\")\n\n    return project_path",
    "source": "github_repo:github/spec-kit",
    "file": "src/specify_cli/__init__.py",
    "license": "MIT",
    "language": "python"
}