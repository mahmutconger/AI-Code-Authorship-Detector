{
    "code": "def _update_agent_history_description(\n\t\tself,\n\t\tmodel_output: AgentOutput | None = None,\n\t\tresult: list[ActionResult] | None = None,\n\t\tstep_info: AgentStepInfo | None = None,\n\t) -> None:\n\t\t\"\"\"Update the agent history description\"\"\"\n\n\t\tif result is None:\n\t\t\tresult = []\n\t\tstep_number = step_info.step_number if step_info else None\n\n\t\tself.state.read_state_description = ''\n\t\tself.state.read_state_images = []  # Clear images from previous step\n\n\t\taction_results = ''\n\t\tresult_len = len(result)\n\t\tread_state_idx = 0\n\n\t\tfor idx, action_result in enumerate(result):\n\t\t\tif action_result.include_extracted_content_only_once and action_result.extracted_content:\n\t\t\t\tself.state.read_state_description += (\n\t\t\t\t\tf'<read_state_{read_state_idx}>\\n{action_result.extracted_content}\\n</read_state_{read_state_idx}>\\n'\n\t\t\t\t)\n\t\t\t\tread_state_idx += 1\n\t\t\t\tlogger.debug(f'Added extracted_content to read_state_description: {action_result.extracted_content}')\n\n\t\t\t# Store images for one-time inclusion in the next message\n\t\t\tif action_result.images:\n\t\t\t\tself.state.read_state_images.extend(action_result.images)\n\t\t\t\tlogger.debug(f'Added {len(action_result.images)} image(s) to read_state_images')\n\n\t\t\tif action_result.long_term_memory:\n\t\t\t\taction_results += f'{action_result.long_term_memory}\\n'\n\t\t\t\tlogger.debug(f'Added long_term_memory to action_results: {action_result.long_term_memory}')\n\t\t\telif action_result.extracted_content and not action_result.include_extracted_content_only_once:\n\t\t\t\taction_results += f'{action_result.extracted_content}\\n'\n\t\t\t\tlogger.debug(f'Added extracted_content to action_results: {action_result.extracted_content}')\n\n\t\t\tif action_result.error:\n\t\t\t\tif len(action_result.error) > 200:\n\t\t\t\t\terror_text = action_result.error[:100] + '......' + action_result.error[-100:]\n\t\t\t\telse:\n\t\t\t\t\terror_text = action_result.error\n\t\t\t\taction_results += f'{error_text}\\n'\n\t\t\t\tlogger.debug(f'Added error to action_results: {error_text}')\n\n\t\t# Simple 60k character limit for read_state_description\n\t\tMAX_CONTENT_SIZE = 60000\n\t\tif len(self.state.read_state_description) > MAX_CONTENT_SIZE:\n\t\t\tself.state.read_state_description = (\n\t\t\t\tself.state.read_state_description[:MAX_CONTENT_SIZE] + '\\n... [Content truncated at 60k characters]'\n\t\t\t)\n\t\t\tlogger.debug(f'Truncated read_state_description to {MAX_CONTENT_SIZE} characters')\n\n\t\tself.state.read_state_description = self.state.read_state_description.strip('\\n')\n\n\t\tif action_results:\n\t\t\taction_results = f'Result\\n{action_results}'\n\t\taction_results = action_results.strip('\\n') if action_results else None\n\n\t\t# Simple 60k character limit for action_results\n\t\tif action_results and len(action_results) > MAX_CONTENT_SIZE:\n\t\t\taction_results = action_results[:MAX_CONTENT_SIZE] + '\\n... [Content truncated at 60k characters]'\n\t\t\tlogger.debug(f'Truncated action_results to {MAX_CONTENT_SIZE} characters')\n\n\t\t# Build the history item\n\t\tif model_output is None:\n\t\t\t# Add history item for initial actions (step 0) or errors (step > 0)\n\t\t\tif step_number is not None:\n\t\t\t\tif step_number == 0 and action_results:\n\t\t\t\t\t# Step 0 with initial action results\n\t\t\t\t\thistory_item = HistoryItem(step_number=step_number, action_results=action_results)\n\t\t\t\t\tself.state.agent_history_items.append(history_item)\n\t\t\t\telif step_number > 0:\n\t\t\t\t\t# Error case for steps > 0\n\t\t\t\t\thistory_item = HistoryItem(step_number=step_number, error='Agent failed to output in the right format.')\n\t\t\t\t\tself.state.agent_history_items.append(history_item)\n\t\telse:\n\t\t\thistory_item = HistoryItem(\n\t\t\t\tstep_number=step_number,\n\t\t\t\tevaluation_previous_goal=model_output.current_state.evaluation_previous_goal,\n\t\t\t\tmemory=model_output.current_state.memory,\n\t\t\t\tnext_goal=model_output.current_state.next_goal,\n\t\t\t\taction_results=action_results,\n\t\t\t)\n\t\t\tself.state.agent_history_items.append(history_item)",
    "source": "github_repo:browser-use/browser-use",
    "file": "browser_use/agent/message_manager/service.py",
    "license": "MIT",
    "language": "python"
}