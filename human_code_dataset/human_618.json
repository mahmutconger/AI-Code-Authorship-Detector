{
    "code": "def process_image(image_data_url: str) -> tuple[str, str]:\n\n    # Extract bytes and media type from base64 data URL\n    media_type = image_data_url.split(\";\")[0].split(\":\")[1]\n    base64_data = image_data_url.split(\",\")[1]\n    image_bytes = base64.b64decode(base64_data)\n\n    img = Image.open(io.BytesIO(image_bytes))\n\n    # Check if image is under max dimensions and size\n    is_under_dimension_limit = (\n        img.width < CLAUDE_MAX_IMAGE_DIMENSION\n        and img.height < CLAUDE_MAX_IMAGE_DIMENSION\n    )\n    is_under_size_limit = len(base64_data) <= CLAUDE_IMAGE_MAX_SIZE\n\n    # If image is under both limits, no processing needed\n    if is_under_dimension_limit and is_under_size_limit:\n        print(\"[CLAUDE IMAGE PROCESSING] no processing needed\")\n        return (media_type, base64_data)\n\n    # Time image processing\n    start_time = time.time()\n\n    # Check if either dimension exceeds 7900px (Claude disallows >= 8000px)\n    # Resize image if needed\n    if not is_under_dimension_limit:\n        # Calculate the new dimensions while maintaining aspect ratio\n        if img.width > img.height:\n            new_width = CLAUDE_MAX_IMAGE_DIMENSION\n            new_height = int((CLAUDE_MAX_IMAGE_DIMENSION / img.width) * img.height)\n        else:\n            new_height = CLAUDE_MAX_IMAGE_DIMENSION\n            new_width = int((CLAUDE_MAX_IMAGE_DIMENSION / img.height) * img.width)\n\n        # Resize the image\n        img = img.resize((new_width, new_height), Image.DEFAULT_STRATEGY)\n        print(\n            f\"[CLAUDE IMAGE PROCESSING] image resized: width = {new_width}, height = {new_height}\"\n        )\n\n    # Convert and compress as JPEG\n    # We always compress as JPEG (95% at the least) even when we resize and the original image\n    # is under the size limit.\n    quality = 95\n    output = io.BytesIO()\n    img = img.convert(\"RGB\")  # Ensure image is in RGB mode for JPEG conversion\n    img.save(output, format=\"JPEG\", quality=quality)\n\n    # Reduce quality until image is under max size\n    while (\n        len(base64.b64encode(output.getvalue())) > CLAUDE_IMAGE_MAX_SIZE\n        and quality > 10\n    ):\n        output = io.BytesIO()\n        img.save(output, format=\"JPEG\", quality=quality)\n        quality -= 5\n\n    # Log so we know it was modified\n    old_size = len(base64_data)\n    new_size = len(base64.b64encode(output.getvalue()))\n    print(\n        f\"[CLAUDE IMAGE PROCESSING] image size updated: old size = {old_size} bytes, new size = {new_size} bytes\"\n    )\n\n    end_time = time.time()\n    processing_time = end_time - start_time\n    print(f\"[CLAUDE IMAGE PROCESSING] processing time: {processing_time:.2f} seconds\")\n\n    return (\"image/jpeg\", base64.b64encode(output.getvalue()).decode(\"utf-8\"))",
    "source": "github_repo:abi/screenshot-to-code",
    "file": "backend/image_processing/utils.py",
    "license": "MIT",
    "language": "python"
}