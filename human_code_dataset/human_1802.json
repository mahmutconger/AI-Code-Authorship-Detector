{
    "code": "def reply_text(self, session: ChatGPTSession, api_key=None, args=None, retry_count=0) -> dict:\n        \"\"\"\n        call openai's ChatCompletion to get the answer\n        :param session: a conversation session\n        :param session_id: session id\n        :param retry_count: retry count\n        :return: {}\n        \"\"\"\n        try:\n            if conf().get(\"rate_limit_chatgpt\") and not self.tb4chatgpt.get_token():\n                raise openai.error.RateLimitError(\"RateLimitError: rate limit exceeded\")\n            # if api_key == None, the default openai.api_key will be used\n            if args is None:\n                args = self.args\n            response = openai.ChatCompletion.create(api_key=api_key, messages=session.messages, **args)\n            # logger.debug(\"[CHATGPT] response={}\".format(response))\n            logger.info(\"[ChatGPT] reply={}, total_tokens={}\".format(response.choices[0]['message']['content'], response[\"usage\"][\"total_tokens\"]))\n            return {\n                \"total_tokens\": response[\"usage\"][\"total_tokens\"],\n                \"completion_tokens\": response[\"usage\"][\"completion_tokens\"],\n                \"content\": response.choices[0][\"message\"][\"content\"],\n            }\n        except Exception as e:\n            need_retry = retry_count < 2\n            result = {\"completion_tokens\": 0, \"content\": \"我现在有点累了，等会再来吧\"}\n            if isinstance(e, openai.error.RateLimitError):\n                logger.warn(\"[CHATGPT] RateLimitError: {}\".format(e))\n                result[\"content\"] = \"提问太快啦，请休息一下再问我吧\"\n                if need_retry:\n                    time.sleep(20)\n            elif isinstance(e, openai.error.Timeout):\n                logger.warn(\"[CHATGPT] Timeout: {}\".format(e))\n                result[\"content\"] = \"我没有收到你的消息\"\n                if need_retry:\n                    time.sleep(5)\n            elif isinstance(e, openai.error.APIError):\n                logger.warn(\"[CHATGPT] Bad Gateway: {}\".format(e))\n                result[\"content\"] = \"请再问我一次\"\n                if need_retry:\n                    time.sleep(10)\n            elif isinstance(e, openai.error.APIConnectionError):\n                logger.warn(\"[CHATGPT] APIConnectionError: {}\".format(e))\n                result[\"content\"] = \"我连接不到你的网络\"\n                if need_retry:\n                    time.sleep(5)\n            else:\n                logger.exception(\"[CHATGPT] Exception: {}\".format(e))\n                need_retry = False\n                self.sessions.clear_session(session.session_id)\n\n            if need_retry:\n                logger.warn(\"[CHATGPT] 第{}次重试\".format(retry_count + 1))\n                return self.reply_text(session, api_key, args, retry_count + 1)\n            else:\n                return result",
    "source": "github_repo:zhayujie/chatgpt-on-wechat",
    "file": "bot/chatgpt/chat_gpt_bot.py",
    "license": "MIT",
    "language": "python"
}