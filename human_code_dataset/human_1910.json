{
    "code": "def det(tf):\n    # fmt: off\n    sp.check_call([\n        b\"ffmpeg\",\n        b\"-nostdin\",\n        b\"-hide_banner\",\n        b\"-v\", b\"fatal\",\n        b\"-y\", b\"-i\", fsenc(sys.argv[1]),\n        b\"-map\", b\"0:a:0\",\n        b\"-ac\", b\"1\",\n        b\"-ar\", b\"22050\",\n        b\"-t\", b\"360\",\n        b\"-f\", b\"f32le\",\n        fsenc(tf)\n    ])\n    # fmt: on\n\n    with open(tf, \"rb\") as f:\n        d = np.fromfile(f, dtype=np.float32)\n        try:\n            # 98% accuracy on jcore\n            c = vamp.collect(d, 22050, \"beatroot-vamp:beatroot\")\n            cl = c[\"list\"]\n        except:\n            # fallback; 73% accuracy\n            plug = \"vamp-example-plugins:fixedtempo\"\n            c = vamp.collect(d, 22050, plug, parameters={\"maxdflen\": 40})\n            print(c[\"list\"][0][\"label\"].split(\" \")[0])\n            return\n\n    # throws if detection failed:\n    beats = [float(x[\"timestamp\"]) for x in cl]\n    bds = [b - a for a, b in zip(beats, beats[1:])]\n    bds.sort()\n    n0 = int(len(bds) * 0.2)\n    n1 = int(len(bds) * 0.75) + 1\n    bds = bds[n0:n1]\n    bpm = sum(bds)\n    bpm = round(60 * (len(bds) / bpm), 2)\n    print(f\"{bpm:.2f}\")\n\n    if SAVE:\n        fdir, fname = os.path.split(sys.argv[1])\n        bdir = os.path.join(fdir, \".beats\")\n        try:\n            os.mkdir(fsenc(bdir))\n        except:\n            pass\n\n        fp = os.path.join(bdir, fname) + \".txt\"\n        with open(fsenc(fp), \"wb\") as f:\n            txt = \"\\n\".join([f\"{x:.2f}\" for x in beats])\n            f.write(txt.encode(\"utf-8\"))",
    "source": "github_repo:9001/copyparty",
    "file": "bin/mtag/audio-bpm.py",
    "license": "MIT",
    "language": "python"
}